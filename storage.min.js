!function(t,e){"use strict";"undefined"!=typeof module?module.exports=e(t):t.define?t.define("$storage",e):t.angular?t.angular.module("jstools.storage",[]).constant("$storage",e()):t.$storage||(t.$storage=e())}(this,function(t){"use strict";function e(t,e){for(var n in e)t[n]=e[n]}function n(t){return function(e){return typeof e===t}}function r(t){return function(e){return e instanceof t}}function o(t){/^{.*}$/.test(t.newValue)&&s.trigger(t.key,JSON.parse(t.newValue)||{},JSON.parse(t.oldValue)||{})}var a=n("string"),i=r(Function),u=r(Array),s=function(t,e,n){return void 0!==e?(s.setItem(t,e,n),this):s.getItem(t)},l={},f={};return s.setItem=function(t,n,r){var o={data:n},a=localStorage.getItem(t)?JSON.parse(localStorage.getItem(t))||{}:{};return e(o,r||{}),localStorage.setItem(t,JSON.stringify(o)),l[t]&&s.trigger(t,o,a),s},s.getItem=function(t){return(JSON.parse(localStorage.getItem(t))||{}).data},s.removeItem=function(t){return localStorage.removeItem(t),s},s.getMeta=function(t,e){return void 0===e?JSON.parse(localStorage.getItem(t))||{}:(JSON.parse(localStorage.getItem(t))||{})[e]},s.loopback=function(t,e){return l[t]=void 0===e||e,s},s.on=function(t,e,n){return a(t)&&i(e)&&(f[t]=f[t]||[],f[t].push({listener:e,context:n})),s},s.off=function(t,e){if(a(t)&&u(f[t]))if(i(e)){for(var n=f[t],r=0,o=n.length;o>r;r++)if(n[r].listener===e)return n.splice(r,1),!0}else e||(f[t]=[]);return s},s.onAny=function(t,e){return i(t)&&(f[""]=f[""]||[],f[""].push({listener:t,context:e})),s},s.offAny=function(t){if(f[""]&&i(t)){for(var e=f[""],n=0,r=e.length;r>n;n++)if(e[n].listener===t)return e.splice(n,1),!0}else f[""]=[];return s},s.trigger=function(t,e,n){var r,o,a=f[t]||[],i=[e.data,n.data,{newValue:e,oldValue:n}];for(r=0,o=a.length;o>r;r++)a[r].listener.apply(a[r].context,i);for(a=f[""]||[],i.unshift(t),r=0,o=a.length;o>r;r++)a[r].listener.apply(a[r].context,i);return s},window.addEventListener?window.addEventListener("storage",o,!1):window.attachEvent&&window.attachEvent("onstorage",o),s});